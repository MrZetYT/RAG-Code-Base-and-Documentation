@page "/"
@page "/files"
@using RAG_Code_Base.Models
@using RAG_Code_Base.Services.DataLoader
@using Microsoft.AspNetCore.Components.Forms
@inject FileLoaderService FileLoaderService
@inject ILogger<FileList> Logger
@inject NavigationManager Navigation
@implements IDisposable

<div class="files-page">
    <div class="page-header">
        <div class="header-content">
            <div class="header-left">
                <h1>📁 Управление файлами</h1>
                <p class="subtitle">Загружайте файлы для создания базы знаний</p>
            </div>
            <div class="header-actions">
                @if (files != null && files.Any())
                {
                    <button @onclick="NavigateToChat" class="btn-primary">
                        💬 Перейти к чату
                    </button>
                    <button @onclick="ShowDeleteAllConfirm" class="btn-danger">
                        🗑️ Удалить все файлы
                    </button>
                }
            </div>
        </div>
    </div>

    <div class="page-content">
        <div class="upload-section">
            <div class="upload-header">
                <div class="upload-icon">📤</div>
                <div>
                    <h3>Загрузить новый файл</h3>
                    <p>Поддерживаемые форматы: .txt, .md, .cs, .py, .js, .ts, .java, .cpp, .c, .rs, .php, .html, .css, .pdf, .docx</p>
                </div>
            </div>

            <InputFile OnChange="HandleFileUpload" class="file-input" id="fileInput" />
            <label for="fileInput" class="upload-button">
                <span>📁 Выбрать файл</span>
            </label>
        </div>

        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-info">
                    <div class="stat-value">@(files?.Count ?? 0)</div>
                    <div class="stat-label">Всего файлов</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-info">
                    <div class="stat-value">@(files?.Count(f => f.Status == FileProcessingStatus.Ready) ?? 0)</div>
                    <div class="stat-label">Готовы</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚙️</div>
                <div class="stat-info">
                    <div class="stat-value">@(files?.Count(f => f.Status == FileProcessingStatus.Parsing || f.Status == FileProcessingStatus.Vectorizing) ?? 0)</div>
                    <div class="stat-label">Обрабатываются</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">❌</div>
                <div class="stat-info">
                    <div class="stat-value">@(files?.Count(f => f.Status == FileProcessingStatus.Failed) ?? 0)</div>
                    <div class="stat-label">Ошибки</div>
                </div>
            </div>
        </div>

        <div class="files-section">
            @if (!string.IsNullOrEmpty(message))
            {
                <div class="@(messageSuccess ? "alert-success" : "alert-error")">
                    <span>@(messageSuccess ? "✅" : "❌")</span>
                    @message
                    <button class="alert-close" @onclick="() => message = null">×</button>
                </div>
            }

            @if (showDeleteAllConfirm)
            {
                <div class="confirm-dialog">
                    <div class="confirm-content">
                        <h3>⚠️ Подтверждение удаления</h3>
                        <p>Вы уверены, что хотите удалить ВСЕ файлы?</p>
                        <p class="confirm-warning">Это действие нельзя отменить!</p>
                        <div class="confirm-actions">
                            <button @onclick="HandleDeleteAll" class="btn-confirm-danger">
                                🗑️ Да, удалить все
                            </button>
                            <button @onclick="() => showDeleteAllConfirm = false" class="btn-cancel">
                                ❌ Отмена
                            </button>
                        </div>
                    </div>
                </div>
            }

            @if (files == null)
            {
                <div class="loading-state">
                    <div class="spinner-large"></div>
                    <p>Загрузка списка файлов...</p>
                </div>
            }
            else if (!files.Any())
            {
                <div class="empty-state">
                    <div class="empty-icon">📭</div>
                    <h3>Файлов пока нет</h3>
                    <p>Загрузите первый файл, чтобы начать работу с базой знаний</p>
                </div>
            }
            else
            {
                <div class="files-grid">
                    @foreach (var file in files.OrderByDescending(f => f.UploadedAt))
                    {
                        <div class="file-card @GetStatusClass(file.Status)">
                            <div class="file-header">
                                <div class="file-icon">@GetFileIcon(file.FileType)</div>
                                <div class="file-info">
                                    <h4 class="file-name" title="@file.FileName">@file.FileName</h4>
                                    <div class="file-meta">
                                        <span class="file-type">@file.FileType</span>
                                        <span class="file-date">@file.UploadedAt.ToString("dd.MM.yyyy HH:mm")</span>
                                    </div>
                                </div>
                            </div>

                            <div class="file-status">
                                <span class="status-badge @GetStatusBadgeClass(file.Status)">
                                    @GetStatusIcon(file.Status) @GetStatusText(file.Status)
                                </span>
                                @if (file.Status == FileProcessingStatus.Parsing || file.Status == FileProcessingStatus.Vectorizing)
                                {
                                    <div class="progress-bar">
                                        <div class="progress-fill"></div>
                                    </div>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(file.ErrorMessage))
                            {
                                <div class="error-details">
                                    ⚠️ @file.ErrorMessage
                                </div>
                            }

                            <div class="file-actions">
                                <button @onclick="() => HandleDelete(file.Id)" class="btn-delete">
                                    🗑️ Удалить
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<style>
    .files-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #1a0033 0%, #000000 100%);
        color: white;
        overflow-y: auto;
    }

    .page-header {
        background: rgba(26, 0, 51, 0.8);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(138, 43, 226, 0.3);
        padding: 30px;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .header-left h1 {
        font-size: 36px;
        margin: 0 0 10px 0;
        color: #fff;
    }

    .subtitle {
        color: rgba(255, 255, 255, 0.7);
        font-size: 16px;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 15px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #8a2be2 0%, #4b0082 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        white-space: nowrap;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.4);
        }

    .btn-danger {
        background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        white-space: nowrap;
    }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(220, 20, 60, 0.4);
        }

    .page-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px;
    }

    .upload-section {
        background: rgba(26, 0, 51, 0.6);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .upload-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
    }

    .upload-icon {
        font-size: 48px;
    }

    .upload-header h3 {
        font-size: 24px;
        margin: 0 0 8px 0;
        color: #fff;
    }

    .upload-header p {
        color: rgba(255, 255, 255, 0.6);
        margin: 0;
        font-size: 14px;
    }

    .file-input {
        display: none;
    }

    .upload-button {
        display: inline-block;
        background: linear-gradient(135deg, #8a2be2 0%, #4b0082 100%);
        color: white;
        padding: 15px 40px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .upload-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 25px rgba(138, 43, 226, 0.4);
        }

    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: rgba(26, 0, 51, 0.6);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 15px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s, border-color 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(138, 43, 226, 0.6);
        }

    .stat-icon {
        font-size: 48px;
    }

    .stat-info {
        flex: 1;
    }

    .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: #fff;
        line-height: 1;
    }

    .stat-label {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 5px;
    }

    .files-section {
        background: rgba(26, 0, 51, 0.6);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 15px;
        padding: 30px;
        min-height: 400px;
    }

    .alert-success, .alert-error {
        padding: 15px 25px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 500;
    }

    .alert-success {
        background: rgba(34, 197, 94, 0.2);
        border: 1px solid rgba(34, 197, 94, 0.5);
        color: #4ade80;
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #f87171;
    }

    .alert-close {
        background: none;
        border: none;
        color: inherit;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .confirm-content {
        background: linear-gradient(135deg, #1a0033 0%, #000000 100%);
        border: 2px solid rgba(138, 43, 226, 0.5);
        border-radius: 15px;
        padding: 40px;
        max-width: 500px;
        text-align: center;
    }

        .confirm-content h3 {
            font-size: 28px;
            margin: 0 0 20px 0;
            color: #fff;
        }

        .confirm-content p {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin: 10px 0;
        }

    .confirm-warning {
        color: #f87171 !important;
        font-weight: 600;
    }

    .confirm-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
    }

    .btn-confirm-danger {
        background: linear-gradient(135deg, #dc143c 0%, #8b0000 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .btn-confirm-danger:hover {
            transform: scale(1.05);
        }

    .btn-cancel {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }

        .btn-cancel:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.2);
        }

    .loading-state, .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 20px;
        color: rgba(255, 255, 255, 0.6);
    }

    .spinner-large {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(138, 43, 226, 0.2);
        border-top-color: #8a2be2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
    }

    .empty-state h3 {
        font-size: 24px;
        color: #fff;
        margin-bottom: 10px;
    }

    .files-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .file-card {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 12px;
        padding: 20px;
        transition: transform 0.2s, border-color 0.2s;
    }

        .file-card:hover {
            transform: translateY(-3px);
            border-color: rgba(138, 43, 226, 0.6);
        }

        .file-card.status-ready {
            border-color: rgba(34, 197, 94, 0.5);
        }

        .file-card.status-failed {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .file-card.status-processing {
            border-color: rgba(251, 191, 36, 0.5);
        }

    .file-header {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .file-icon {
        font-size: 40px;
        flex-shrink: 0;
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
        margin: 0 0 8px 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-meta {
        display: flex;
        gap: 10px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.6);
    }

    .file-type {
        background: rgba(138, 43, 226, 0.2);
        padding: 2px 8px;
        border-radius: 8px;
        font-weight: 500;
    }

    .file-status {
        margin-bottom: 15px;
    }

    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

        .status-badge.badge-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.5);
        }

        .status-badge.badge-processing {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.5);
        }

        .status-badge.badge-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

    .progress-bar {
        height: 4px;
        background: rgba(138, 43, 226, 0.2);
        border-radius: 2px;
        margin-top: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #8a2be2, #4b0082);
        border-radius: 2px;
        animation: progress 2s ease-in-out infinite;
    }

    @@keyframes progress {
        0% {
            width: 0;
        }

        50% {
            width: 70%;
        }

        100% {
            width: 100%;
        }
    }

    .error-details {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #f87171;
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
        margin-bottom: 15px;
    }

    .file-actions {
        display: flex;
        justify-content: flex-end;
    }

    .btn-delete {
        background: rgba(220, 20, 60, 0.2);
        border: 1px solid rgba(220, 20, 60, 0.5);
        color: #f87171;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
    }

        .btn-delete:hover {
            background: rgba(220, 20, 60, 0.3);
            transform: translateY(-2px);
        }

    .files-page::-webkit-scrollbar {
        width: 12px;
    }

    .files-page::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.3);
    }

    .files-page::-webkit-scrollbar-thumb {
        background: rgba(138, 43, 226, 0.5);
        border-radius: 6px;
    }

        .files-page::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 43, 226, 0.7);
        }
</style>

@code {
    private List<FileItem>? files;
    private string? message;
    private bool messageSuccess;
    private bool showDeleteAllConfirm = false;
    private System.Threading.Timer? _refreshTimer;

    protected override void OnInitialized()
    {
        LoadFiles();
        StartAutoRefresh();
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                LoadFiles();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
    }

    private void LoadFiles()
    {
        files = FileLoaderService.GetAllFiles();
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        message = null;

        try
        {
            var file = e.File;

            using var stream = file.OpenReadStream(maxAllowedSize: 52428800);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            var formFile = new FormFile(memoryStream, 0, memoryStream.Length, file.Name, file.Name)
            {
                Headers = new HeaderDictionary(),
                ContentType = file.ContentType
            };

            var savedFile = FileLoaderService.SaveFile(formFile);
            message = $"Файл '{savedFile.FileName}' успешно загружен!";
            messageSuccess = true;
            LoadFiles();
        }
        catch (Exception ex)
        {
            message = $"Ошибка: {ex.Message}";
            messageSuccess = false;
        }
    }

    private void HandleDelete(Guid id)
    {
        try
        {
            Logger.LogInformation("Попытка удаления файла {FileId}", id);

            var success = FileLoaderService.DeleteFile(id);

            if (success)
            {
                message = "Файл успешно удалён!";
                messageSuccess = true;
                LoadFiles();
            }
            else
            {
                message = "Файл не найден.";
                messageSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка удаления файла {FileId}", id);
            message = $"Ошибка: {ex.Message}";
            messageSuccess = false;
        }
    }

    private void ShowDeleteAllConfirm()
    {
        showDeleteAllConfirm = true;
    }

    private void HandleDeleteAll()
    {
        try
        {
            Logger.LogInformation("Попытка удаления всех файлов");

            var success = FileLoaderService.DeleteAllFiles();

            if (success)
            {
                message = "Все файлы успешно удалены!";
                messageSuccess = true;
                LoadFiles();
            }
            else
            {
                message = "Не удалось удалить файлы.";
                messageSuccess = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка удаления всех файлов");
            message = $"Ошибка: {ex.Message}";
            messageSuccess = false;
        }
        finally
        {
            showDeleteAllConfirm = false;
        }
    }

    private void NavigateToChat()
    {
        Navigation.NavigateTo("/chat");
    }

    private string GetStatusClass(FileProcessingStatus status)
    {
        return status switch
        {
            FileProcessingStatus.Ready => "status-ready",
            FileProcessingStatus.Failed => "status-failed",
            _ => "status-processing"
        };
    }

    private string GetStatusBadgeClass(FileProcessingStatus status)
    {
        return status switch
        {
            FileProcessingStatus.Ready => "badge-ready",
            FileProcessingStatus.Failed => "badge-failed",
            _ => "badge-processing"
        };
    }

    private string GetStatusText(FileProcessingStatus status)
    {
        return status switch
        {
            FileProcessingStatus.Uploaded => "Загружен",
            FileProcessingStatus.Parsing => "Парсинг...",
            FileProcessingStatus.Vectorizing => "Векторизация...",
            FileProcessingStatus.Ready => "Готов",
            FileProcessingStatus.Failed => "Ошибка",
            _ => status.ToString()
        };
    }

    private string GetStatusIcon(FileProcessingStatus status)
    {
        return status switch
        {
            FileProcessingStatus.Uploaded => "📦",
            FileProcessingStatus.Parsing => "🔍",
            FileProcessingStatus.Vectorizing => "🧮",
            FileProcessingStatus.Ready => "✅",
            FileProcessingStatus.Failed => "❌",
            _ => "❓"
        };
    }

    private string GetFileIcon(string fileType)
    {
        return fileType switch
        {
            "CSharp" => "🔷",
            "Python" => "🐍",
            "JavaScript" => "💛",
            "TypeScript" => "💙",
            "Java" => "☕",
            "Markdown" => "📝",
            "Text" => "📄",
            "PDF" => "📕",
            "DOCX" => "📘",
            _ => "📄"
        };
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}